<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil del Alumno</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    @keyframes slideIn {
      0% {
        transform: perspective(1000px) rotateY(70deg) translateZ(-300px);
        opacity: 0;
      }

      100% {
        transform: perspective(1000px) rotateY(0deg) translateZ(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      0% {
        transform: perspective(1000px) rotateY(0deg) translateZ(0);
        opacity: 1;
      }

      100% {
        transform: perspective(1000px) rotateY(70deg) translateZ(-300px);
        opacity: 0;
      }
    }

    .animate-slideIn {
      animation: slideIn 0.6s ease-out forwards;
    }

    .animate-slideOut {
      animation: slideOut 0.6s ease-in forwards;
    }

    /* Estilo para tabla responsiva en móviles */
    @media (max-width: 767px) {
      .admin-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .admin-table {
        min-width: 350px;
        /* Asegura un ancho mínimo para que no se vea todo aplastado */
      }

      .admin-table thead,
      .admin-table tbody,
      .admin-table th,
      .admin-table td,
      .admin-table tr {
        display: block;
      }

      .admin-table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      .admin-table tr {
        border: 1px solid #ddd;
        margin-bottom: 0.5rem;
      }

      .admin-table td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%;
        text-align: right;
        font-size: 0.875rem;
        /* text-sm */
      }

      .admin-table td:before {
        position: absolute;
        top: 0;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
        content: attr(data-label);
      }

      /* Estilos específicos para cada columna en móvil */
      .admin-table td:nth-of-type(1):before {
        content: "ID";
      }

      .admin-table td:nth-of-type(2):before {
        content: "Nombre";
      }

      .admin-table td:nth-of-type(3):before {
        content: "Tareas";
      }

      .admin-table td:nth-of-type(4):before {
        content: "Monedas";
      }

      .admin-table td:nth-of-type(5):before {
        content: "Asistencia";
      }

      .admin-table td:nth-of-type(6):before {
        /* NEW */
        content: "Games/Challenges";
      }

      .admin-table td:nth-of-type(7):before {
        content: "EXP.";
      }

      .admin-table td:nth-of-type(8):before {
        content: "Nivel";
      }

      .admin-table td:nth-of-type(9):before {
        /* Adjusted index */
        content: "Acciones";
      }

      /* Ajustes para los controles de + y - */
      .admin-table .flex.items-center {
        justify-content: flex-end;
        /* Alinear los controles a la derecha */
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200">
  <div id="root" class="w-full flex items-center justify-center"></div>

  <script type="text/babel">
    const BACKEND_BASE_URL = window.location.origin;
    // const BACKEND_BASE_URL = 'http://localhost:3000'; // Descomment for local testing

    const LoginScreen = ({
      studentId, setStudentId,
      password, setPassword,
      handleLogin,
      setShowRegister,
      setShowReset,
      showCodeField,
      resetId, setResetId,
      resetCode, setResetCode,
      resetPass, setResetPass,
      handleSendResetCode,
      handleUpdatePassword,
      selectedCareer, setSelectedCareer,
      setShowAdminLoginModal
    }) => {
      const sideImage = selectedCareer === 'Diseno Digital' ? '/img/side-image.jpg' : '/img/comuni.png';

      return (
        <>
          <div className="flex flex-col md:flex-row w-screen h-screen">
            <div className="hidden md:block md:w-1/2 bg-cover bg-center" style={{ backgroundImage: `url('${sideImage}')` }}></div>
            <div className="w-full md:w-1/2 flex items-center justify-center bg-white p-8">
              <div className="w-full max-w-md px-6 py-8 text-center">
                <img src={selectedCareer === 'Diseno Digital' ? "logo.png" : "/img/Com.png"} alt="Logo" className="mx-auto w-32 h-32 mb-4" />
                <h2 className="text-3xl font-bold mb-4 text-gray-800">
                  {selectedCareer === 'Diseno Digital' ? 'Diseño Digital' : 'Diseño de la Comunicación'}
                </h2>

                <select
                  className="w-full p-3 mb-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300"
                  value={selectedCareer}
                  onChange={(e) => setSelectedCareer(e.target.value)}
                >
                  <option value="Diseno Digital">Diseño Digital</option>
                  <option value="Diseno de la Comunicacion">Diseño de la Comunicación</option>
                </select>

                <input className="w-full p-3 mb-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300" placeholder="ID de Alumno"
                  value={studentId} onChange={(e) => setStudentId(e.target.value)} />
                <input type="password" className="w-full p-3 mb-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300" placeholder="Contraseña"
                  value={password} onChange={(e) => setPassword(e.target.value)} />
                <button className="bg-orange-500 text-white px-4 py-3 rounded-full shadow-lg hover:bg-orange-600 transition-all duration-300 w-full font-semibold"
                  onClick={handleLogin}>Iniciar sesión</button>

                <div className="text-sm mt-6">
                  <button onClick={() => setShowRegister(true)} className="text-purple-600 hover:underline mr-4 transition-colors duration-300">Sign in</button>
                  <button onClick={() => setShowReset(true)} className="text-red-500 hover:underline transition-colors duration-300">¿Olvidaste tu contraseña?</button>
                  <button onClick={() => setShowAdminLoginModal(true)} className="text-blue-500 hover:underline ml-4 transition-colors duration-300">Administrador</button>
                </div>
              </div>
            </div>
          </div>
        </>
      );
    };

    const AdminLoginModal = ({ show, onClose, onAdminLoginSuccess, selectedCareer }) => {
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');

      const handleAdminLogin = async () => {
        const response = await fetch(`${BACKEND_BASE_URL}/api/admin-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        const data = await response.json();
        if (data.success) {
          alert(data.message);
          onAdminLoginSuccess(selectedCareer);
          onClose();
        } else {
          alert(data.error);
        }
      };

      if (!show) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300">
          <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-4 transform transition-transform duration-300 scale-95 hover:scale-100">
            <h2 className="text-2xl font-bold text-center text-gray-800">Acceso de Administrador</h2>
            <input className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition-all duration-300" placeholder="Usuario" value={username} onChange={(e) => setUsername(e.target.value)} />
            <input type="password" className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition-all duration-300" placeholder="Contraseña" value={password} onChange={(e) => setPassword(e.target.value)} />
            <button className="bg-blue-600 text-white px-4 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 w-full font-semibold" onClick={handleAdminLogin}>Iniciar sesión (Admin)</button>
            <button className="text-sm text-gray-500 hover:underline mt-2 transition-colors duration-300" onClick={onClose}>Cancelar</button>
          </div>
        </div>
      );
    };

    const AdminDashboard = ({ show, onClose, studentsData, updateStudentData, selectedCareer, calculateLevel, onRefreshStudents }) => {
      if (!show) return null;

      const [editableStudents, setEditableStudents] = React.useState(studentsData || []);

      React.useEffect(() => {
        setEditableStudents(studentsData || []);
      }, [studentsData]);

      const handleFieldChange = (index, field, value) => {
        const updatedStudents = [...editableStudents];
        updatedStudents[index] = { ...updatedStudents[index], [field]: value };
        setEditableStudents(updatedStudents);
      };

      const handleUpdateClick = async (student) => {
        const { id, rowIndex, tareas, monedas, asistencias, exp, gamesChallenges } = student;
        const response = await fetch(`${BACKEND_BASE_URL}/api/admin/update-student-data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, career: selectedCareer, rowIndex, tareas, monedas, asistencias, exp, gamesChallenges }),
        });
        const data = await response.json();
        if (data.success) {
          alert(`Datos de ${id} actualizados correctamente.`);
          if (onRefreshStudents) {
            await onRefreshStudents(selectedCareer);
          }
        } else {
          alert(data.error);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
          <div className="bg-white p-4 sm:p-8 rounded-2xl shadow-2xl w-full max-w-5xl mx-auto transform transition-transform duration-300 scale-95 hover:scale-100 h-5/6 flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl sm:text-2xl font-bold text-gray-800">Panel de Administrador - {selectedCareer === 'Diseno Digital' ? 'Diseño Digital' : 'Diseño de la Comunicación'}</h3>
              <button onClick={onClose} className="text-red-500 text-xl font-bold">X</button>
            </div>
            {/* Contenedor de la tabla responsiva */}
            <div className="flex-grow overflow-y-auto admin-table-container">
              <table className="w-full text-left table-auto border-collapse admin-table">
                <thead>
                  <tr className="bg-gray-200 text-gray-700 font-semibold sticky top-0">
                    <th className="p-2 border text-sm">ID</th>
                    <th className="p-2 border text-sm">Nombre</th>
                    <th className="p-2 border text-sm w-[100px]">Tareas</th> {/* Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[100px]">Monedas</th> {/* Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[100px]">Asistencia</th> {/* Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[140px]">Games/Challenges</th> {/* NEW: Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[80px]">EXP.</th> {/* Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[80px]">Nivel</th> {/* Ancho fijo para móvil */}
                    <th className="p-2 border text-sm w-[120px]">Acciones</th> {/* Ancho fijo para móvil */}
                  </tr>
                </thead>
                <tbody>
                  {editableStudents.map((student, index) => (
                    <tr key={student.id} className="border-b hover:bg-gray-50">
                      <td className="p-2 border text-sm" data-label="ID">{student.id}</td>
                      <td className="p-2 border text-sm" data-label="Nombre">{student.name}</td>
                      <td className="p-2 border" data-label="Tareas">
                        <div className="flex items-center justify-end md:justify-center">
                          <button onClick={() => handleFieldChange(index, 'tareas', student.tareas - 1)} className="bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">-</button>
                          <span className="w-10 sm:w-12 text-center mx-1 border-b py-0.5 text-sm">{student.tareas}</span>
                          <button onClick={() => handleFieldChange(index, 'tareas', student.tareas + 1)} className="bg-green-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">+</button>
                        </div>
                      </td>
                      <td className="p-2 border" data-label="Monedas">
                        <div className="flex items-center justify-end md:justify-center">
                          <button onClick={() => handleFieldChange(index, 'monedas', student.monedas - 1)} className="bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">-</button>
                          <span className="w-10 sm:w-12 text-center mx-1 border-b py-0.5 text-sm">{student.monedas}</span>
                          <button onClick={() => handleFieldChange(index, 'monedas', student.monedas + 1)} className="bg-green-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">+</button>
                        </div>
                      </td>
                      <td className="p-2 border" data-label="Asistencia">
                        <div className="flex items-center justify-end md:justify-center">
                          <button onClick={() => handleFieldChange(index, 'asistencias', student.asistencias - 1)} className="bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">-</button>
                          <span className="w-10 sm:w-12 text-center mx-1 border-b py-0.5 text-sm">{student.asistencias}</span>
                          <button onClick={() => handleFieldChange(index, 'asistencias', student.asistencias + 1)} className="bg-green-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">+</button>
                        </div>
                      </td>
                      <td className="p-2 border" data-label="Games/Challenges"> {/* NEW */}
                        <div className="flex items-center justify-end md:justify-center">
                          <button onClick={() => handleFieldChange(index, 'gamesChallenges', student.gamesChallenges - 1)} className="bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">-</button>
                          <span className="w-10 sm:w-12 text-center mx-1 border-b py-0.5 text-sm">{student.gamesChallenges}</span>
                          <button onClick={() => handleFieldChange(index, 'gamesChallenges', student.gamesChallenges + 1)} className="bg-green-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm">+</button>
                        </div>
                      </td>
                      <td className="p-2 border text-center" data-label="EXP.">
                        <span className="w-full text-center py-0.5 block text-sm">{student.exp}</span>
                      </td>
                      <td className="p-2 border text-center" data-label="Nivel">{calculateLevel(student.exp)}</td>
                      <td className="p-2 border text-center" data-label="Acciones">
                        <button className="bg-blue-500 text-white px-3 py-1 rounded-full text-xs hover:bg-blue-600" onClick={() => handleUpdateClick(student)}>Actualizar</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [showLeaderboard, setShowLeaderboard] = React.useState(false);
      const [leaderboardData, setLeaderboardData] = React.useState([]);

      const fetchLeaderboard = async () => {
        const response = await fetch(`${BACKEND_BASE_URL}/api/leaderboard?career=${selectedCareer}`);
        const data = await response.json();
        if (data.success) {
          setLeaderboardData(data.leaderboard);
          setShowLeaderboard(true);
        }
      };

      const [isLoggedIn, setIsLoggedIn] = React.useState(false);
      const [studentId, setStudentId] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [studentData, setStudentData] = React.useState(null);
      const [badges, setBadges] = React.useState([]);
      const [cart, setCart] = React.useState({});
      const [showCartModal, setShowCartModal] = React.useState(false);

      const [showRegister, setShowRegister] = React.useState(false);
      const [showReset, setShowReset] = React.useState(false);
      const [showCodeField, setShowCodeField] = React.useState(false);
      const [resetId, setResetId] = React.useState('');
      const [resetCode, setResetCode] = React.useState('');
      const [resetPass, setResetPass] = React.useState('');
      const [showLevelUpGif, setShowLevelUpGif] = React.useState(false);
      const [selectedCareer, setSelectedCareer] = React.useState('Diseno Digital');
      const [registerCareer, setRegisterCareer] = React.useState(selectedCareer);

      const [isAdminLoggedIn, setIsAdminLoggedIn] = React.useState(false);
      const [showAdminLoginModal, setShowAdminLoginModal] = React.useState(false);
      const [adminStudentsData, setAdminStudentsData] = React.useState([]);
      const [showAdminDashboard, setShowAdminDashboard] = React.useState(false);


      const prevLevelRef = React.useRef(null);

      const levelThresholds = { 0: 0, 1: 10, 2: 25, 3: 50, 4: 75, 5: 100 };

      const calculateLevel = (exp) => {
        if (exp >= 100) return 5;
        if (exp >= 75) return 4;
        if (exp >= 50) return 3;
        if (exp >= 25) return 2;
        if (exp >= 10) return 1;
        return 0;
      };

      const getLevelProgress = (exp, level) => {
        const currentLevelExp = levelThresholds[level];
        const nextLevelExp = levelThresholds[level + 1] === undefined ? 100 : levelThresholds[level + 1];
        const expInLevel = exp - currentLevelExp;
        const expForNextLevel = nextLevelExp - currentLevelExp;
        const percentage = (expInLevel / expForNextLevel) * 100;
        return {
          percentage: isNaN(percentage) ? 0 : percentage,
          currentExp: exp,
          requiredExp: nextLevelExp
        };
      };

      React.useEffect(() => {
        if (studentData) {
          const currentLevel = studentData.level;
          const prevLevel = prevLevelRef.current;

          if (prevLevel !== null && currentLevel > prevLevel) {
            alert(`¡Felicidades, has subido de nivel!\nNivel anterior: ${prevLevel}\nNivel actual: ${currentLevel}`);
            setShowLevelUpGif(true);
            setTimeout(() => setShowLevelUpGif(false), 4000);
          }
          prevLevelRef.current = currentLevel;
        }
      }, [studentData]);

      const handleLogin = async () => {
        const response = await fetch(`${BACKEND_BASE_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId, password, career: selectedCareer }),
        });
        const data = await response.json();
        if (data.success) {
          data.student.level = calculateLevel(data.student.exp);
          setStudentData(data.student);
          setIsLoggedIn(true);
          prevLevelRef.current = data.student.level;

          if (data.levelUpOccurred) {
            setShowLevelUpGif(true);
            setTimeout(() => setShowLevelUpGif(false), 4000);
          }
        } else {
          alert(data.error);
        }
      };

      const handleLogout = () => {
        setIsLoggedIn(false);
        setStudentId('');
        setPassword('');
        setStudentData(null);
        setBadges([]);
        setCart({});
        setShowCartModal(false);
        setShowRegister(false);
        setShowReset(false);
        setShowCodeField(false);
        setResetId('');
        setResetCode('');
        setResetPass('');
        setShowLevelUpGif(false);
        prevLevelRef.current = null;
        setSelectedCareer('Diseno Digital');
        setIsAdminLoggedIn(false);
        setShowAdminLoginModal(false);
        setAdminStudentsData([]);
        setShowAdminDashboard(false);
      };

      const fetchBadges = async () => {
        const response = await fetch(`${BACKEND_BASE_URL}/api/badges?career=${selectedCareer}`);
        const data = await response.json();
        setBadges(data.badges || []);
      };

      const totalCartCost = Object.keys(cart).reduce((total, name) => {
        const badge = badges.find(b => b.name === name);
        return total + ((badge?.cost || 0) * (cart[name] || 0));
      }, 0);

      const addToCart = (name, available) => {
        const currentQuantity = cart[name] || 0;
        const badge = badges.find(b => b.name === name);
        const newTotal = totalCartCost + (badge?.cost || 0);
        if (studentData && currentQuantity < available && newTotal <= parseInt(studentData.monedas)) {
          setCart(prev => ({ ...prev, [name]: currentQuantity + 1 }));
        }
      };

      const removeFromCart = (name) => {
        setCart(prev => {
          const qty = prev[name] || 0;
          if (qty <= 1) {
            const { [name]: _, ...rest } = prev;
            return rest;
          }
          return { ...prev, [name]: qty - 1 };
        });
      };

      const handlePurchase = async () => {
        if (!studentData) return;

        const items = Object.keys(cart).map(name => {
          const badge = badges.find(b => b.name === name);
          return { itemName: name, quantityToBuy: cart[name], itemCost: badge?.cost || 0, };
        });

        for (const item of items) {
          const response = await fetch(`${BACKEND_BASE_URL}/api/purchase`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: studentData.id, studentRowIndex: studentData.rowIndex, ...item, career: selectedCareer }),
          });
          const data = await response.json();

          setStudentData(prev => {
            const updatedStudent = { ...prev, monedas: data.newCoins.toString(), purchases: { ...prev.purchases, [item.itemName]: (prev.purchases[item.itemName] || 0) + item.quantityToBuy } };
            updatedStudent.level = calculateLevel(updatedStudent.exp);
            return updatedStudent;
          });

          setBadges(prevBadges => prevBadges.map(b => b.name === item.itemName ? { ...b, quantity: data.newBadgeQuantity } : b));
        }
        setCart({});
        setShowCartModal(false);
      };

      const handleSendResetCode = async () => {
        if (!resetId) return alert("Ingresa tu ID.");
        try {
          const res = await fetch(`${BACKEND_BASE_URL}/api/send-reset-code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: resetId, career: selectedCareer }),
          });
          const data = await res.json();
          if (data.message) {
            alert(data.message);
            setShowCodeField(true);
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Error sending reset code:', error);
          alert('Error al enviar el código. Intenta de nuevo más tarde.');
        }
      };

      const handleUpdatePassword = async () => {
        if (!resetId || !resetCode || !resetPass) return alert("Completa todos los campos.");
        try {
          const res = await fetch(`${BACKEND_BASE_URL}/api/reset-password-with-code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: resetId, code: resetCode, password: resetPass, career: selectedCareer }),
          });
          const data = await res.json();
          if (data.message) {
            alert(data.message);
            setShowReset(false);
            setShowCodeField(false);
            setResetId('');
            setResetCode('');
            setResetPass('');
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Error updating password:', error);
          alert('Error al actualizar la contraseña. Intenta de nuevo más tarde.');
        }
      };

      const handleRegister = async (newStudentData) => {
        try {
          const response = await fetch(`${BACKEND_BASE_URL}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...newStudentData, career: registerCareer }),
          });
          const data = await response.json();
          if (data.message) {
            alert(data.message);
            setShowRegister(false); // Cierra el modal de registro al éxito
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Error registering student:', error);
          alert('Error al registrar alumno. Intenta de nuevo más tarde.');
        }
      };

      const handleAdminLoginSuccess = (career) => {
        setIsAdminLoggedIn(true);
        fetchAdminStudentsData(career);
        setShowAdminDashboard(true);
      };

      const fetchAdminStudentsData = async (career) => {
        try {
          const response = await fetch(`${BACKEND_BASE_URL}/api/admin/students?career=${career}`);
          const data = await response.json();
          if (data.success) {
            setAdminStudentsData(data.students);
          } else {
            alert(data.error);
          }
        } catch (error) {
          console.error('Error fetching admin students data:', error);
          alert('Error al cargar datos de alumnos para el administrador.');
        }
      };

      const updateStudentDataInAdminDashboard = async (id, rowIndex, updatedData) => {
        try {
          const response = await fetch(`${BACKEND_BASE_URL}/api/admin/update-student-data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, rowIndex, ...updatedData, career: selectedCareer }),
          });
          const data = await response.json();
          if (data.success) {
            // Actualizar solo el estudiante específico en el estado `adminStudentsData`
            setAdminStudentsData(prevStudents =>
              prevStudents.map(student =>
                student.id === id ? { ...student, ...updatedData, level: calculateLevel(updatedData.exp) } : student
              )
            );
            return { success: true };
          } else {
            alert(data.error);
            return { success: false, error: data.error };
          }
        } catch (error) {
          console.error('Error updating student data:', error);
          alert('Error al actualizar los datos del alumno.');
          return { success: false, error: error.message };
        }
      };


      if (isLoggedIn && studentData) {
        const { percentage, currentExp, requiredExp } = getLevelProgress(studentData.exp, studentData.level);
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 flex items-center justify-center p-4 w-full">
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl transform transition-all duration-300 scale-100 hover:scale-[1.01] relative">
              {showLevelUpGif && (
                <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 z-50 rounded-2xl animate-slideIn">
                  <img src="/img/levelup.gif" alt="Level Up!" className="max-w-full max-h-full" />
                </div>
              )}
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-4xl font-bold text-gray-800">
                  Bienvenido, {studentData.name} <span className="text-purple-600">({studentData.id})</span>
                </h1>
                <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-full shadow hover:bg-red-600 transition-colors duration-300">Cerrar Sesión</button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div className="bg-purple-50 p-6 rounded-xl shadow-md">
                  <h2 className="text-2xl font-semibold text-purple-700 mb-4">Progreso</h2>
                  <p className="text-lg text-gray-700 mb-2">Nivel: <span className="font-bold text-purple-800">{studentData.level}</span></p>
                  <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div className="bg-purple-600 h-4 rounded-full" style={{ width: `${percentage}%` }}></div>
                  </div>
                  <p className="text-sm text-gray-600">EXP: {currentExp} / {requiredExp} ({percentage.toFixed(0)}%)</p>
                  <p className="text-lg text-gray-700 mt-4">Tareas Completadas: <span className="font-bold text-blue-600">{studentData.tareas}</span></p>
                  <p className="text-lg text-gray-700">Monedas: <span className="font-bold text-yellow-600">{studentData.monedas}</span></p>
                  <p className="text-lg text-gray-700">Asistencias: <span className="font-bold text-green-600">{studentData.asistencias}</span></p>
                  <p className="text-lg text-gray-700">Games/Challenges: <span className="font-bold text-pink-600">{studentData.gamesChallenges}</span></p> {/* NEW */}
                </div>

                <div className="bg-yellow-50 p-6 rounded-xl shadow-md">
                  <h2 className="text-2xl font-semibold text-yellow-700 mb-4">Tus Insignias</h2>
                  {Object.keys(studentData.purchases).length > 0 ? (
                    <ul className="space-y-2">
                      {Object.entries(studentData.purchases).map(([badgeName, quantity]) => (
                        <li key={badgeName} className="flex justify-between items-center text-gray-700">
                          <span>{badgeName}</span>
                          <span className="font-bold text-yellow-800">x{quantity}</span>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p className="text-gray-600">Aún no tienes insignias. ¡Visita la tienda!</p>
                  )}
                  <button
                    onClick={() => {
                      fetchBadges();
                      setShowCartModal(true);
                    }}
                    className="mt-6 bg-yellow-500 text-white px-6 py-3 rounded-full shadow-lg hover:bg-yellow-600 transition-colors duration-300 font-semibold"
                  >
                    Ir a la Tienda
                  </button>
                </div>
              </div>
              <div className="text-center">
                <button onClick={fetchLeaderboard} className="bg-indigo-500 text-white px-6 py-3 rounded-full shadow-lg hover:bg-indigo-600 transition-colors duration-300 font-semibold">
                  Ver Clasificación
                </button>
              </div>

            </div>

            {showCartModal && (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 animate-slideIn">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg space-y-6 transform scale-95 hover:scale-100 transition-transform duration-300">
                  <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">Tienda de Insignias</h2>
                  <div className="max-h-80 overflow-y-auto pr-2">
                    {badges.length > 0 ? (
                      <ul className="space-y-4">
                        {badges.map(badge => (
                          <li key={badge.name} className="flex items-center justify-between border-b pb-4">
                            <div>
                              <p className="text-xl font-semibold text-gray-700">{badge.name}</p>
                              <p className="text-gray-500">Costo: {badge.cost} Monedas | Disponibles: {badge.quantity}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                              <span className="text-lg text-gray-700">En carrito: {cart[badge.name] || 0}</span>
                              <button
                                onClick={() => addToCart(badge.name, badge.quantity)}
                                className="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-xl font-bold hover:bg-green-600 transition-colors duration-200"
                                disabled={cart[badge.name] >= badge.quantity || totalCartCost + badge.cost > studentData.monedas}
                              >
                                +
                              </button>
                              <button
                                onClick={() => removeFromCart(badge.name)}
                                className="bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-xl font-bold hover:bg-red-600 transition-colors duration-200"
                                disabled={!cart[badge.name]}
                              >
                                -
                              </button>
                            </div>
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <p className="text-center text-gray-600">No hay insignias disponibles en este momento.</p>
                    )}
                  </div>

                  <div className="mt-6 pt-4 border-t text-center">
                    <p className="text-2xl font-bold text-gray-800 mb-4">Total en Carrito: {totalCartCost} Monedas</p>
                    <p className="text-xl text-gray-700 mb-6">Tus Monedas Disponibles: {studentData.monedas}</p>
                    <button
                      onClick={handlePurchase}
                      className="bg-blue-600 text-white px-8 py-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 font-semibold text-lg mr-4"
                      disabled={totalCartCost === 0 || totalCartCost > studentData.monedas}
                    >
                      Comprar
                    </button>
                    <button
                      onClick={() => {
                        setShowCartModal(false);
                        setCart({});
                      }}
                      className="bg-gray-400 text-white px-8 py-4 rounded-full shadow-lg hover:bg-gray-500 transition-colors duration-300 font-semibold text-lg"
                    >
                      Cerrar
                    </button>
                  </div>
                </div>
              </div>
            )}

            {showLeaderboard && (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 animate-slideIn">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl space-y-6 transform scale-95 hover:scale-100 transition-transform duration-300">
                  <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">Tabla de Clasificación ({selectedCareer === 'Diseno Digital' ? 'Diseño Digital' : 'Diseño de la Comunicación'})</h2>
                  <div className="max-h-96 overflow-y-auto">
                    <table className="min-w-full bg-white rounded-lg shadow-md">
                      <thead>
                        <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                          <th className="py-3 px-6 text-left">Posición</th>
                          <th className="py-3 px-6 text-left">Nombre</th>
                          <th className="py-3 px-6 text-center">Nivel</th>
                          <th className="py-3 px-6 text-center">EXP</th>
                          <th className="py-3 px-6 text-center">Monedas</th>
                        </tr>
                      </thead>
                      <tbody className="text-gray-600 text-sm font-light">
                        {leaderboardData.map((entry, index) => (
                          <tr key={entry.id} className="border-b border-gray-200 hover:bg-gray-100">
                            <td className="py-3 px-6 text-left whitespace-nowrap">
                              <span className="font-bold">{index + 1}</span>
                            </td>
                            <td className="py-3 px-6 text-left">
                              {entry.name}
                              {entry.id === studentData.id && <span className="ml-2 text-purple-600 font-semibold">(Tú)</span>}
                            </td>
                            <td className="py-3 px-6 text-center">{entry.level}</td>
                            <td className="py-3 px-6 text-center">{entry.exp}</td>
                            <td className="py-3 px-6 text-center">{entry.monedas}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="text-center mt-6">
                    <button onClick={() => setShowLeaderboard(false)} className="bg-gray-400 text-white px-8 py-3 rounded-full shadow-lg hover:bg-gray-500 transition-colors duration-300 font-semibold">
                      Cerrar
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <>
          <LoginScreen
            studentId={studentId}
            setStudentId={setStudentId}
            password={password}
            setPassword={setPassword}
            handleLogin={handleLogin}
            setShowRegister={setShowRegister}
            setShowReset={setShowReset}
            showCodeField={showCodeField}
            resetId={resetId}
            setResetId={setResetId}
            resetCode={resetCode}
            setResetCode={setResetCode}
            resetPass={resetPass}
            setResetPass={setResetPass}
            handleSendResetCode={handleSendResetCode}
            handleUpdatePassword={handleUpdatePassword}
            selectedCareer={selectedCareer}
            setSelectedCareer={setSelectedCareer}
            setShowAdminLoginModal={setShowAdminLoginModal}
          />

          {showRegister && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300">
              <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-4 transform scale-95 hover:scale-100 transition-transform duration-300">
                <h2 className="text-2xl font-bold text-center text-gray-800">Registro de Alumno</h2>
                <select
                  className="w-full p-3 mb-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300"
                  value={registerCareer}
                  onChange={(e) => setRegisterCareer(e.target.value)}
                >
                  <option value="Diseno Digital">Diseño Digital</option>
                  <option value="Diseno de la Comunicacion">Diseño de la Comunicación</option>
                </select>
                <input className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300" placeholder="ID de Alumno"
                  value={studentId} onChange={(e) => setStudentId(e.target.value)} />
                <input className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300" placeholder="Nombre Completo"
                  onChange={(e) => setStudentData(prev => ({ ...prev, name: e.target.value }))} />
                <select className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300"
                  onChange={(e) => setStudentData(prev => ({ ...prev, sexo: e.target.value }))}>
                  <option value="">Selecciona Sexo</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                </select>
                <input type="password" className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 transition-all duration-300" placeholder="Contraseña (4 caracteres HEX mayúsculas)"
                  pattern="^[A-Z0-9]{4}$" title="La contraseña debe ser de 4 caracteres HEX mayúsculas (ej. A1B2)"
                  value={password} onChange={(e) => setPassword(e.target.value)} />
                <button className="bg-green-500 text-white px-4 py-3 rounded-full shadow-lg hover:bg-green-600 transition-all duration-300 w-full font-semibold"
                  onClick={() => handleRegister({ id: studentId, name: studentData?.name, sexo: studentData?.sexo, password: password })}>Registrar</button>
                <button className="text-sm text-gray-500 hover:underline mt-2 transition-colors duration-300" onClick={() => setShowRegister(false)}>Cancelar</button>
              </div>
            </div>
          )}

          {showReset && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300">
              <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-4 transform scale-95 hover:scale-100 transition-transform duration-300">
                <h2 className="text-2xl font-bold text-center text-gray-800">Restablecer Contraseña</h2>
                <input className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 transition-all duration-300" placeholder="ID de Alumno"
                  value={resetId} onChange={(e) => setResetId(e.target.value)} />
                <button className="bg-orange-500 text-white px-4 py-3 rounded-full shadow-lg hover:bg-orange-600 transition-all duration-300 w-full font-semibold" onClick={handleSendResetCode}>Enviar Código</button>

                {showCodeField && (
                  <>
                    <input className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 transition-all duration-300" placeholder="Código de 6 dígitos"
                      value={resetCode} onChange={(e) => setResetCode(e.target.value)} />
                    <input type="password" className="w-full border p-3 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-orange-500 transition-all duration-300" placeholder="Nueva Contraseña (4 caracteres HEX mayúsculas)"
                      pattern="^[A-Z0-9]{4}$" title="La contraseña debe ser de 4 caracteres HEX mayúsculas (ej. A1B2)"
                      value={resetPass} onChange={(e) => setResetPass(e.target.value)} />
                    <button className="bg-orange-500 text-white px-4 py-3 rounded-full shadow-lg hover:bg-orange-600 transition-all duration-300 w-full mt-2 font-semibold" onClick={handleUpdatePassword}>Actualizar contraseña</button>
                  </>
                )}

                <button className="text-sm text-gray-500 hover:underline mt-2 transition-colors duration-300" onClick={() => {
                  setShowReset(false);
                  setShowCodeField(false);
                  setResetId('');
                  setResetCode('');
                  setResetPass('');
                }}>Cancelar</button>
              </div>
            </div>
          )}

          <AdminLoginModal
            show={showAdminLoginModal}
            onClose={() => setShowAdminLoginModal(false)}
            onAdminLoginSuccess={handleAdminLoginSuccess}
            selectedCareer={selectedCareer}
          />

          <AdminDashboard
            show={showAdminDashboard}
            onClose={handleLogout}
            studentsData={adminStudentsData}
            updateStudentData={updateStudentDataInAdminDashboard}
            selectedCareer={selectedCareer}
            calculateLevel={calculateLevel}
            onRefreshStudents={fetchAdminStudentsData}
          />
        </>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>